# 数据模型

数据模型，百度词典解释为数据特征的描述，描述了数据的静态特性，动态行为和约束条件，数据模型所描述的内容有三部分：数据结构、数据操作和数据约束。

damo中数据模型的作用基本符合描述内容，前端应用中状态数组主要分成2种：接口数据 和 组件UI状态数据。

数据模型是提供开发者一种用于针对状态数据进行分类管理，并且把数据存储到全局唯一的状态容器store中，以供组件获取数据进行渲染。

> damo中数据模型可以当做服务来使用，因为本身就是一个JS类，但是数据模型只能对store进行写入操作，如果组件需要获取store数据只能通过数据绑定来完成，下篇章有做介绍。

### 创建数据模型

创建数据模型必须继承于BaseModel服务基类

```
class User extends damo.BaseModel{
    static initialState = {
        profile: {}
    }
    getUser() {
        return this.getQuery({
              response: Api.get('https://api.github.com/users/baqian'),
              processData: res => res,
              change: {
                name: 'profile',
                callback: data => data
              }
        })(this.dispatch);
    }
}
```

创建了一个User的数据模型，包含了数据结构和动态行为：

1. 数据结构，user为空对象
2. 动态行为，getUser方法去更新profile的数据，解释一下如何实现
   1. 动态行为更新数据结构，必须通过调用`this.getQuery`方法（由BaseModel继承下来的），这是发起一个连接store后的执行语句。不通过`this.getQuery`只能是一个纯函数调用，对改变store数据起不到效果。
   2. `this.getQuery`语句执行后返回一个回调函数，是否触发更新store，需要传入`this.dispatch`（BaseModel继承下来），dispatch是一个分发器，传入了this.dispatch表达要更新到store中。

此时我们会有疑问，不是动态行为的this.getQuery发起的执行语句，不就是为了更新store，为何还非要调用传入this.dispatch呢。实际上有这样的方式调用，但同时this.getQuery还是有存在的场景（懒执行的效果）。

```
getUser(){
    return this.execQuery({
        response: Api.get('https://api.github.com/users/baqian'),
        processData: res => res,
        change: {
          name: 'profile',
          callback: data => data
        }
    });
}
```

通过`this.execQuery`是发起执行语句并且理解执行更新到store中，传入的option配置保持一致，来学习下配置项：

1. response，是数据装载对象，只能接收Promise类型，事实上数据装载的方式有3种。
   1. Promise数据，response就属于这一类型。
   2. 接口调用，可以吧fetch接口调用的配置项打散到option中。
   3. 数据获取及数据更新集中处理式，这种复杂场景在核心知识章节介绍，这里不做深入解读。
2. processData，是数据提取后的预处理函数，默认的预处理函数为`processData: res => res.data`
3. change，写入数据到store中策略，我们先掌握最直接的方式，复杂形式在核心知识章节详细介绍。
   1. name属性时要更新数据结构，只能是在Model内的数据结构
   2. callback是处理后的数据写入更新。
4. 如果要一次更新多个数据结构，可以使用chagnes代码change。

### 数据模型的使用

数据模型添加到damo框架中，通过damo的数据驱动机制来运作，以下有3中方式添加数据模型。

```
// 类方式，需要指定实例名称
User.displayName = 'user';
damo.model(User);
// 数组方式，类方式添加多个
damo.model([User]);
// 对象方式，key为实例名称
damo.model({user: User});
```

在复杂项目中，我们会考虑把数据模型自动化添加到框架中，比如model目录下的所有js文件都作为一个数据模型添加进来。

```
damo.autoLoadModels(require.context('./models', false, /\.js$/))
```



